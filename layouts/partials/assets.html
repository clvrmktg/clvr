{{- $font := .Site.Params.font -}}
{{- /* 1. Preconnect */ -}}
{{- if .Store.Get "hasTwic"}}
<link rel="dns-prefetch" href="https://{{ .Site.Params.twic }}.twic.pics">
<link rel="preconnect" href="https://{{ .Site.Params.twic }}.twic.pics" crossorigin>
{{- end }}
{{- $mpID := getenv "META_PIXEL_ID" -}}
{{- if and (eq hugo.Environment "production") $mpID -}}
<link rel="dns-prefetch" href="https://connect.facebook.net">
<link rel="preconnect" href="https://connect.facebook.net" crossorigin>
<link rel="dns-prefetch" href="https://www.facebook.com">
<link rel="preconnect" href="https://www.facebook.com" crossorigin>
{{- end -}}
{{with $font }}
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
{{end}}
{{- /* 2. Preload styles first */ -}}
{{- $style := resources.Get "styles/style.sass" }}
{{- $opts := dict
  "enableSourceMap" (not hugo.IsProduction)
  "outputStyle" (cond hugo.IsProduction "compressed" "expanded")
  "targetPath" "styles/style.css"
  "transpiler" "dartsass"
}}
{{- $compiled := $style | toCSS $opts }}
{{- $fingerprinted := cond hugo.IsProduction ($compiled | fingerprint "sha256") $compiled }}

<link rel="preload" href="{{ $fingerprinted.RelPermalink }}" as="style"
  {{- if hugo.IsProduction }} integrity="{{ $fingerprinted.Data.Integrity }}" crossorigin="anonymous"{{- end }}>

{{- /* 5. Preload Twic script AFTER styles (low priority) */ -}}
{{- if .Store.Get "hasTwic"}}
  <link rel="preload" href="https://{{ .Site.Params.twic }}.twic.pics/?v1" as="script">
{{- end }}
{{ with $font }}
  <link href="{{ $font }}" rel="stylesheet">
{{ end }}
<link rel="stylesheet" href="{{ $fingerprinted.RelPermalink }}"
  {{- if hugo.IsProduction }} integrity="{{ $fingerprinted.Data.Integrity }}" crossorigin="anonymous"{{- end }}>

<noscript>
  <style>.script { display: none; visibility: hidden }</style>
</noscript>

{{- /* 6. Actual scripts (deferred or async) */ -}}
{{- if .Store.Get "hasTwic" }}
  <script src="https://{{ .Site.Params.twic }}.twic.pics/?v1" async defer></script>
{{- end }}

{{- /* partials/partytown-analytics.html */ -}}
{{- $gaID := getenv "GA_TRACKING_ID" -}}
{{- $mpID := getenv "META_PIXEL_ID" -}}
{{- $isProd := eq hugo.Environment "production" -}}
{{- $shouldLoad := and $isProd (or $gaID $mpID) -}}
{{- /* partials/partytown-analytics.html */ -}}
{{- $gaID := getenv "GA_TRACKING_ID" -}}
{{- $mpID := getenv "META_PIXEL_ID" -}}
{{- $isProd := eq hugo.Environment "production" -}}

{{- if and $isProd (or $gaID $mpID) -}}
  {{- /* Build the list of globals to forward into the worker */ -}}
  {{- $forward := slice -}}
  {{- if $gaID -}}
    {{- $forward = $forward | append "gtag" "dataLayer.push" -}}
  {{- end -}}
  {{- if $mpID -}}
    {{- $forward = $forward | append "fbq" -}}
  {{- end -}}

  <!-- Partytown config + tiny stubs (main thread) -->
  <script>
    window.partytown = { forward: {{ $forward | jsonify }} };

    {{- if $gaID -}}
    window.dataLayer = window.dataLayer || [];
    window.gtag = function(){ dataLayer.push(arguments); };
    {{- end -}}

    {{- if $mpID -}}
    window.fbq = function(){ (fbq.q = fbq.q || []).push(arguments); };
    {{- end -}}
  </script>

  <!-- Partytown runtime (served from static/~partytown/) -->
  <script src="/~partytown/partytown.js"></script>

  {{- if $gaID -}}
    <!-- Google Analytics in worker -->
    <script type="text/partytown" src="https://www.googletagmanager.com/gtag/js?id={{ $gaID }}"></script>
    <script type="text/partytown">
      gtag('js', new Date());
      gtag('config', '{{ $gaID }}', { send_page_view: true });
    </script>
  {{- end -}}

  {{- if $mpID -}}
    <!-- Facebook Pixel in worker -->
    <script type="text/partytown" src="https://connect.facebook.net/en_US/fbevents.js"></script>
    <script type="text/partytown">
      fbq('init', '{{ $mpID }}');
      fbq('track', 'PageView');
    </script>
  {{- end -}}
{{- end -}}


