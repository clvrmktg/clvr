{{- $font := .Site.Params.font -}}
{{- /* 1. Preconnect */ -}}
{{- if .Store.Get "hasTwic"}}
<link rel="dns-prefetch" href="https://{{ .Site.Params.twic }}.twic.pics">
<link rel="preconnect" href="https://{{ .Site.Params.twic }}.twic.pics" crossorigin>

{{- end }}
{{with $font }}
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
{{end}}
{{- $root := . -}}
{{- with $root.Params.hero }}
  {{- $twic := printf "https://%s.twic.pics" $root.Site.Params.twic -}}
  {{- $href := printf "%s/%s?twic=v1/cover=1920x1080" $twic .path -}}

  {{- if hugo.IsProduction }}
  <link
    rel="preload"
    as="image"
    href="{{ $href | safeURL }}"
    imagesrcset="
      {{ $twic }}/{{ .path }}?twic=v1/cover=640x360    640w,
      {{ $twic }}/{{ .path }}?twic=v1/cover=1024x576  1024w,
      {{ $twic }}/{{ .path }}?twic=v1/cover=1536x864  1536w,
      {{ $twic }}/{{ .path }}?twic=v1/cover=1920x1080 1920w"
    imagesizes="100vw">
  {{- end }}
{{- end }}
{{- /* 2. Preload styles first */ -}}
{{- $style := resources.Get "styles/style.sass" }}
{{- $opts := dict
  "enableSourceMap" (not hugo.IsProduction)
  "outputStyle" (cond hugo.IsProduction "compressed" "expanded")
  "targetPath" "styles/style.css"
  "transpiler" "dartsass"
}}
{{- $compiled := $style | toCSS $opts }}
{{- $fingerprinted := cond hugo.IsProduction ($compiled | fingerprint "sha256") $compiled }}

<link rel="preload" href="{{ $fingerprinted.RelPermalink }}" as="style"
  {{- if hugo.IsProduction }} integrity="{{ $fingerprinted.Data.Integrity }}" crossorigin="anonymous"{{- end }}>

{{- /* 5. Preload Twic script AFTER styles (low priority) */ -}}
{{- if .Store.Get "hasTwic"}}
  <link rel="preload" href="https://{{ .Site.Params.twic }}.twic.pics/?v1" as="script">
{{- end }}
{{ with $font }}
  <link href="{{ $font }}" rel="stylesheet">
{{ end }}
<link rel="stylesheet" href="{{ $fingerprinted.RelPermalink }}"
  {{- if hugo.IsProduction }} integrity="{{ $fingerprinted.Data.Integrity }}" crossorigin="anonymous"{{- end }}>

<noscript>
  <style>.script { display: none; visibility: hidden }</style>
</noscript>

{{- /* 6. Actual scripts (deferred or async) */ -}}
{{- if .Store.Get "hasTwic" }}
  <script src="https://{{ .Site.Params.twic }}.twic.pics/?v1" async defer></script>
{{- end }}
{{/* 
  {{- if .Store.Get "hasCode" -}}
  {{ partial "script.html" (dict "path" "scripts/vendor/prism.js" "targetPath" "scripts/prism.js") }}
  {{- end -}}  
*/}}

{{ partial "gtag.html" . }}
