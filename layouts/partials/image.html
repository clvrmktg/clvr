{{- $p      := .page -}}
{{- $meta   := .image -}}                   {{/* expects { path, alt?, caption? } */}}

{{- $file := $meta.path | default "" -}}
{{- $res  := cond (and $p $file) ($p.Resources.GetMatch $file) nil -}}

{{- if $res -}}
  {{- $twic := site.Params.Twic -}}
  {{- $rel  := strings.TrimPrefix "/" $res.RelPermalink -}}   {{/* Twic likes paths without leading slash */}}

  {{- $idSeed       := $rel -}}
  {{- $hex          := replace (printf "%x" (hash.FNV32a (print $idSeed ":js"))) "-" "" -}}
  {{- $noscriptHex  := replace (printf "%x" (hash.FNV32a (print $idSeed ":noscript"))) "-" "" -}}

  <figure{{ if or .class .ratio }} class="{{ if .class }}[ {{ .class }} ]{{ end }}{{ if .ratio }}[ ratio--{{ .ratio }} {{ if .helper }}{{ .helper }} {{end}}]{{end}}"{{end}} data-script>
    <picture id="image-{{ $hex }}" class="[ bg ][ r--10 ]">
      <img
        data-twic-src="image:{{ $res.RelPermalink }}"
        data-twic-focus="auto"
        alt="{{ $meta.alt | default $p.Title }}"
        width="{{ $res.Width }}"
        height="{{ $res.Height }}"
      />
    </picture>
    {{ with .caption }}<figcaption>{{ . }}</figcaption>{{ end }}
  </figure>

  <noscript>
    <figure{{ if or .class .ratio }} class="{{ if .class }}[ {{ .class }} ]{{ end }}{{ if .ratio }}[ ratio--{{ .ratio }} {{ if .helper }}{{ .helper }} {{end}}]{{end}}"{{end}}>
      <picture id="image-{{ $noscriptHex }}" class="[ bg ][ r--10 ]">
        <img
          src="https://{{ $twic }}.twic.pics/{{ $rel }}?twic=v1/focus=auto"
          alt="{{ $meta.alt | default $p.Title }}"
          width="{{ $res.Width }}"
          height="{{ $res.Height }}"
        />
      </picture>
      {{ with .caption }}<figcaption>{{ . }}</figcaption>{{ end }}
    </figure>
  </noscript>

  <style>
    /* scripted bg preview */
    #image-{{ $hex }} {
      background-image: url('https://{{ $twic }}.twic.pics/{{ $rel }}?twic=v1/output=preview');
    }
    /* noscript bg preview */
    #image-{{ $noscriptHex }} {
      background-image: url('https://{{ $twic }}.twic.pics/{{ $rel }}?twic=v1/focus=auto/output=preview');
    }
    #image-{{ $noscriptHex }} > img { opacity: 1; }
  </style>
{{- else -}}
  {{- warnf "No image found: %q on page %q (is it a page bundle file?)" $file (cond $p $p.Path "unknown") -}}
  {{/* quiet fail: render nothing */}}
{{- end -}}
