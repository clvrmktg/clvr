{{- $mpID := getenv "META_PIXEL_ID" -}}
{{- if and (eq hugo.Environment "production") $mpID -}}
  {{- $version := .GitInfo.Hash | default (now.Unix) -}}
  <script>
    (function(){
      if (window.__mpLazyQueued) return;
      function loadMetaPixel(){
        if (window.__mpLazyLoaded) return;
        var s = document.createElement('script');
        s.src = '/.netlify/functions/meta-pixel?v={{ $version }}';
        s.async = true;
        document.head.appendChild(s);
        window.__mpLazyLoaded = true;
      }
      if ('requestIdleCallback' in window) {
        requestIdleCallback(loadMetaPixel, { timeout: 5000 });
      } else {
        setTimeout(loadMetaPixel, 3000);
      }
      window.__mpLazyQueued = true;
    })();
  </script>
  <noscript>
    <img height="1" width="1" style="display:none"
         src="https://www.facebook.com/tr?id={{ $mpID }}&ev=PageView&noscript=1" />
  </noscript>
{{- end -}}