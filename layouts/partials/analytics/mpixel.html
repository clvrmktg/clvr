{{- $mpID := getenv "META_PIXEL_ID" -}}
{{- if and (eq hugo.Environment "production") $mpID -}}
<script>
  (function(w,d){
    var q=[]; function fbq(){ q.push(arguments); }
    fbq.push=q; fbq.loaded=false; fbq.version='2.0';
    w.fbq = fbq;

    fbq('init', '{{ $mpID }}');

    function load(){
      if (fbq.loaded) return;
      var s=d.createElement('script');
      s.async=true;
      s.src='/.netlify/functions/meta-pixel/js';  // âœ… correct path
      s.onload=function(){ fbq.loaded=true; };
      d.head.appendChild(s);
    }
    (w.requestIdleCallback || function(cb){ setTimeout(cb,1200); })(load);

    // Fire PageView with robust fallbacks (LCP OR load OR timeout)
    try {
      new PerformanceObserver((list,obs)=>{
        if(!list.getEntries()[0]) return;
        obs.disconnect();
        fbq('track','PageView');
        fired = true;
      }).observe({type:'largest-contentful-paint', buffered:true});
    } catch(_) {}
    var fired = false;
    addEventListener('load', function(){ if(!fired){ fired=true; fbq('track','PageView'); } }, {once:true});
    setTimeout(function(){ if(!fired){ fired=true; fbq('track','PageView'); } }, 3000);
  })(window,document);
</script>

<noscript>
  <img height="1" width="1" style="display:none"
       src="/.netlify/functions/meta-pixel/tr?ev=PageView&noscript=1" />
</noscript>
{{- end -}}
