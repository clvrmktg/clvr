{{- $pixelID := getenv "META_PIXEL_ID" -}}
{{- if and (eq hugo.Environment "production") $pixelID -}}
  {{- $version := .GitInfo.Hash | default (now.Unix) -}}
  {{- $opts := dict "minify" hugo.IsProduction "targetPath" "scripts/meta-pixel-init.js" -}}
  {{- with resources.Get "scripts/analytics/meta-pixel-init.js" | js.Build $opts -}}
    {{- if hugo.IsProduction -}}
      {{- with . | fingerprint -}}
<script
  src="{{ .RelPermalink }}"
  integrity="{{ .Data.Integrity }}" crossorigin="anonymous"
  defer
  data-pixel-id="{{ $pixelID }}"
  data-locale="en_US"
  data-version="{{ $version }}"></script>
      {{- end -}}
    {{- else -}}
<script
  src="{{ .RelPermalink }}"
  defer
  data-pixel-id="{{ $pixelID }}"
  data-locale="en_US"
  data-version="{{ $version }}"></script>
    {{- end -}}
  {{- end -}}

  {{/* Regular noscript beacon */}}
  <noscript>
    <img height="1" width="1" style="display:none"
         src="https://www.facebook.com/tr?id={{ $pixelID }}&ev=PageView&noscript=1" />
  </noscript>
{{- end -}}
