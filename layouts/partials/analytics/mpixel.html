{{- $mpID := getenv "META_PIXEL_ID" -}}
{{- if and (eq hugo.Environment "production") $mpID -}}
<script>
  // Tiny fbq stub: queue calls until the real library is ready
  (function(w,d){
    var q = [];
    function fbq(){ q.push(arguments); }
    fbq.callMethod = function(){ q.push(arguments); };
    fbq.push = q; fbq.loaded = false; fbq.version = '2.0';
    w.fbq = fbq;

    // Initialize now (queued, zero work done yet)
    fbq('init', '{{ $mpID }}');
    // Don't fire PageView yetâ€”wait for consent/idle/LCP (see below)

    // Lazy load the real library during idle time
    function load() {
      if (fbq.loaded) return;
      var s = d.createElement('script');
      s.async = true;
      s.src = '/.netlify/functions/meta-pixel'; // your proxied fbevents.js
      s.onload = function(){ fbq.loaded = true; };
      d.head.appendChild(s);
    }

    // requestIdleCallback with fallback
    (w.requestIdleCallback || function(cb){ setTimeout(cb, 1500); })(load);
  })(window, document);
</script>
<noscript>
  <img height="1" width="1" style="display:none"
       src="https://www.facebook.com/tr?id={{ $mpID  }}&ev=PageView&noscript=1"/>
</noscript>
{{- end -}}